# General life-table analysis

# Init ------------------------------------------------------------

set.seed(1987)

library(here); library(glue)
library(tidyverse); library(yaml)
library(patchwork)

# Constants -------------------------------------------------------

wd <- here()
cnst <- list()
config <- read_yaml(glue('{wd}/cfg/config.yaml'))
cnst <- within(cnst, {
  regions_for_analysis = config$regions_for_all_cause_analysis
  path_out = glue('{wd}/out')
  path_tmp = glue('{wd}/tmp')
  # number of Poisson life-table replicates
  n_sim = 100
})

dat <- list()
fig <- list()

# Function --------------------------------------------------------

source(glue('{wd}/cfg/fig_specs.R'))

# simple piecewise-exponential life-table
CalculateLifeTable <-
  function (df, x, nx, Dx, Ex) {

    require(dplyr)

    df %>%
      transmute(
        x = {{x}},
        nx = {{nx}},
        mx = {{Dx}}/{{Ex}},
        px = exp(-mx*{{nx}}),
        qx = 1-px,
        lx = head(cumprod(c(1, px)), -1),
        dx = c(-diff(lx), tail(lx, 1)),
        Lx = ifelse(mx==0, lx*nx, dx/mx),
        Tx = rev(cumsum(rev(Lx))),
        ex = Tx/lx
      )

  }

# Data ------------------------------------------------------------

dat$lt_input_100 <- readRDS(glue('{cnst$path_out}/lt_input.rds'))

# Create open age group 85+ ---------------------------------------

dat$lt_input_85 <-
  dat$lt_input_100 %>%
  # for each life-table input stratum create age group 85+
  group_by(region_iso, sex, year) %>%
  group_modify(~{
    input_sorted <- arrange(.x, age_start)
    lt85 <- filter(input_sorted, age_start <= 85)
    lt85p <- filter(input_sorted, age_start > 85)

    lt85[nrow(lt85), 'age_width'] <- Inf
    lt85[nrow(lt85), 'death_total'] <- sum(lt85p$death_total)
    lt85[nrow(lt85), 'population_midyear'] <- sum(lt85p$population_midyear)
    lt85[nrow(lt85), 'population_py'] <- sum(lt85p$population_py)
    lt85[nrow(lt85), 'death_covid'] <- sum(lt85p$death_covid)

    return(lt85)
  }) %>%
  ungroup() %>%
  # harmonize order of variables
  select(all_of(names(dat$lt_input_100)))

# Subset to countries of interest ---------------------------------

dat$lt_input_85_sub <-
  dat$lt_input_85 %>%
  filter(region_iso %in% cnst$regions_for_analysis)

dat$lt_input_100_sub <-
  dat$lt_input_100 %>%
  filter(region_iso %in% cnst$regions_for_analysis)

# Create Poisson life-table replicates ----------------------------

dat$lt_85_sim <-
  dat$lt_input_85_sub %>%
  filter(year >= 2019) %>%
  expand_grid(id_sim = 1:cnst$n_sim) %>%
  group_by(region_iso, sex, year, age_start) %>%
  mutate(death_total_sim = rpois(cnst$n_sim, death_total)) %>%
  arrange(region_iso, sex, year, age_start) %>%
  group_by(id_sim, region_iso, sex, year) %>%
  group_modify(~{
    CalculateLifeTable(.x, age_start, age_width, death_total_sim, population_py)
  }) %>%
  ungroup()

# Calculate annual life tables ------------------------------------

# life-tables by region, sex, and year

# open age_group 100+
dat$lt_100 <-
  dat$lt_input_100_sub %>%
  arrange(region_iso, sex, year, age_start) %>%
  group_by(region_iso, sex, year) %>%
  group_modify(~{
    CalculateLifeTable(.x, age_start, age_width, death_total, population_py)
  }) %>%
  ungroup()

# open age group 85+
dat$lt_85 <-
  dat$lt_input_85_sub %>%
  arrange(region_iso, sex, year, age_start) %>%
  group_by(region_iso, sex, year) %>%
  group_modify(~{
    CalculateLifeTable(.x, age_start, age_width, death_total, population_py)
  }) %>%
  ungroup()

# Analyze ex and hx changes ---------------------------------------

# average yearly change in mx, ex 2015 to 2019
dat$lt_avg_annual_change_pre2020 <-
  dat$lt_85 %>%
  arrange(region_iso, sex, x, year) %>%
  filter(year %in% 2015:2019) %>%
  group_by(region_iso, sex, x) %>%
  # the na.rm statements here mean that an average is
  # calculated even if data is missing for some years
  # in the 2015:2019 period
  summarise(
    # arithmetic mean of ex annual change
    ex_avgdiff_pre2020 = mean(diff(ex), na.rm = TRUE),
    # geometric mean of mx relative annual change
    mx_avgratio_pre2020 = prod(mx[-1]/head(mx, -1), na.rm = TRUE)^(1/(n()-1))
  ) %>%
  ungroup()
# change in mx, ex 2020 to 2019
dat$lt_annual_change_2020 <-
  dat$lt_85 %>%
  filter(year %in% c(2019, 2020)) %>%
  select(region_iso, sex, year, x, mx, ex) %>%
  pivot_wider(names_from = year, values_from = c(mx, ex)) %>%
  mutate(
    ex_diff_2020 = ex_2020 - ex_2019,
    mx_ratio_2020 = mx_2020 / mx_2019
  )
# join average pre 2020 and 2020 changes
dat$lt_annual_change <-
  full_join(
    dat$lt_avg_annual_change_pre2020,
    dat$lt_annual_change_2020,
    by  = c('region_iso', 'sex', 'x')
  )

# plot changes in remaining e0, e60
# from 2019 to 2020 by sex and region and compare with average
# annual change over 2015 to 2019 period
walk(c(0, 60), ~{
  fig[[glue('e{.x}_change')]] <<-
    dat$lt_annual_change %>%
    filter(x == .x) %>%
    mutate(
      x = as.factor(x),
      region_iso = fct_reorder(region_iso, -ex_diff_2020)
    ) %>%
    ggplot(aes(x = region_iso, color = sex, fill = sex, group = sex)) +
    geom_col(aes(y = 0)) + # workaround so tht geom_vline works with discrete scale
    geom_vline(
      xintercept = seq(2, length(cnst$regions_for_analysis), 2),
      size = 3, color = '#eaeaea'
    ) +
    geom_col(
      aes(y = ex_diff_2020),
      position = position_dodge(width = 0.6), width = 0.4
    ) +
    geom_point(
      aes(x = region_iso, fill = sex, y = ex_avgdiff_pre2020),
      position = position_dodge(width = 0.6), shape = 21,
      color = 'white'
    ) +
    geom_hline(yintercept = 0) +
    coord_flip(ylim = c(-2, 1)) +
    scale_y_continuous(
      breaks = seq(-2, 2, 0.5),
      labels = c('-2 years', '', '-1', '', '0', '', '+1', '', '+2 years gained')
    ) +
    scale_fill_manual(values = fig_spec$sex_colors) +
    scale_color_manual(values = fig_spec$sex_colors) +
    guides(
      color = guide_legend(reverse = TRUE),
      fill = guide_legend(reverse = TRUE)
    ) +
    labs(
      subtitle = glue('at age {.x}'),
      y = NULL,
      x = NULL
    ) +
    fig_spec$MyGGplotTheme(grid = 'x', scaler = 0.8, show_legend = FALSE)
})

fig$ex_change <-
  fig$e0_change +
  annotate('text', x = 2, y = -1.5, label = 'Female', size = 3,
           color = fig_spec$sex_colors['Female'], hjust = 1) +
  annotate('text', x = 3, y = -1.5, label = 'Male', size = 3,
           color = fig_spec$sex_colors['Male'], hjust = 1) +
  fig$e60_change +
  plot_layout(guides = 'collect') +
  plot_annotation(
    title = 'Annual change in years of remaining life-expectancy 2019 to 2020',
    subtitle = 'Points mark the average annual change in life-expectancy 2015 to 2019'
  )
fig$ex_change

# compare hazards
fig$hx_change <-
  dat$lt_annual_change %>%
  ggplot(aes(x = x, color = sex)) +
  geom_line(aes(y = mx_2020), size = 0.3) +
  geom_line(aes(y = mx_2019), linetype = 6, size = 0.3) +
  facet_wrap(~region_iso) +
  scale_y_log10() +
  scale_color_manual(values = fig_spec$sex_colors) +
  fig_spec$MyGGplotTheme(panel_border = TRUE, scaler = 0.8) +
  labs(x = 'Age', y = 'Deaths per person-year of exposure',
       title = 'Hazard rates 2020 compared with 2019 (dashed)')
fig$hx_change

# Analyze mx change -----------------------------------------------

dat$mx_change <-
  dat$lt_85_sim %>%
  mutate(
    age_group = cut(x, c(0, 40, 60, 70, Inf), right = FALSE)
  ) %>%
  group_by(id_sim, region_iso, sex, year, age_group) %>%
  summarise(
    mx = sum(dx)/sum(Lx)
  ) %>%
  pivot_wider(names_from = year, values_from = mx) %>%
  mutate(diff = `2020`/`2019`) %>%
  group_by(region_iso, sex, age_group) %>%
  summarise(
    mean_diff = mean(diff),
    q025_diff = quantile(diff, 0.025),
    q975_diff = quantile(diff, 0.975),
    sig_elevated = ifelse(q025_diff > 1, TRUE, FALSE)
  )

fig$mx_change <-
  dat$mx_change %>%
  ggplot(aes(x = age_group, color = sex, group = sex)) +
  geom_hline(yintercept = 1, color = 'grey') +
  geom_pointrange(aes(
    y = mean_diff,ymin = q025_diff, ymax = q975_diff,
    alpha = sig_elevated
  ), fatten = 1, position = position_dodge(width = 0.5)) +
  scale_y_log10(breaks = c(0.8, 1, 1.2),
                labels = c('.8', '1', '1.2')) +
  scale_color_manual(values = fig_spec$sex_colors) +
  facet_wrap(~region_iso) +
  fig_spec$MyGGplotTheme(scaler = 0.8, panel_border = TRUE) +
  coord_flip() +
  scale_alpha_manual(values = c(0.2, 1)) +
  labs(
    title = 'Ratio of life-table death rates 2020 to 2019',
    subtitle = '95% CIs via Poisson simulation of raw death counts',
    x = 'Age group', y = 'Ratio 2020 to 2019'
  )
fig$mx_change

# Compare our ex estimates with wpp estimates ---------------------

walk(c(0, 60), ~{
  fig[[glue('e{.x}_consistency_check')]] <<-
    bind_rows(
      `85+` = filter(dat$lt_85, x == .x),
      `100+` = filter(dat$lt_100, x == .x),
      .id = 'open_age_group'
    ) %>%
    ggplot(aes(x = year, y = ex, color = sex)) +
    geom_segment(
      aes(x = 2015, xend = 2019, y = ex_wpp_estimate,
          yend = ex_wpp_estimate),
      size = 1, alpha = 0.5,
      data =
        dat$lt_input_85_sub %>%
        filter(age_start == .x, year == 2018)
    ) +
    geom_point(aes(shape = open_age_group)) +
    geom_line(
      aes(y = ex_hmd_estimate),
      data =
        dat$lt_input_85_sub %>%
        filter(age_start == .x)
    ) +
    facet_wrap(~region_iso, scales = 'free_y') +
    scale_x_continuous(
      breaks = 2015:2020,
      labels = c('', '2016', '', '2018', '', '2020')
    ) +
    scale_color_manual(values = fig_spec$sex_colors) +
    scale_shape_manual(values = c(`85+` = 1, `100+` = 3)) +
    fig_spec$MyGGplotTheme(panel_border = TRUE, grid = 'xy', scaler = 0.8) +
    labs(
      title = glue('Estimated yearly life expectancy at age {.x} compared with HMD (thin line) and WPP (bold line) 5 year average estimates'),
      y = glue('e{.x}'),
      shape = 'Open age group',
      color = 'Sex'
    )
})
fig$e0_consistency_check
fig$e60_consistency_check

# Export ----------------------------------------------------------

# save the regrouped life table input data
saveRDS(dat$lt_input_85, file = glue('{wd}/out/lt_input_85.rds'))

# save the all cause life tables
saveRDS(dat$lt_85, file = glue('{wd}/out/lt_output_85.rds'))
saveRDS(dat$lt_100, file = glue('{wd}/out/lt_output_100.rds'))

# save e0, e60 change
fig_spec$ExportFigure(fig$ex_change, path = cnst$path_out)

# save the hazard change
fig_spec$ExportFigure(fig$hx_change, path = cnst$path_out)

# save the life-table death rate change
fig_spec$ExportFigure(fig$mx_change, path = cnst$path_out)

# save the ex consistency checks
fig_spec$ExportFigure(fig$e0_consistency_check, path = cnst$path_out)
fig_spec$ExportFigure(fig$e60_consistency_check, path = cnst$path_out)
